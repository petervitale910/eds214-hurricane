---
title: "paper.qmd"
format: html
editor: visual
---

#### Background

We have data from four river sites Quebrada Cuenca 1-3 (q1, q2, q3) and Rio Mameyes Puente Roto (mpr). We are trying to recreate this figure from Schaefer et al. (2000).

![](Schaefer_etal_2020_fig3.png){fig-align="center" width="400"}

In the study they were examining the response in water chemistry following the disturbance of hurricane hugo. I'm going to start by going into the library of all the packages I will be using. I'm using the pacman package to load all of my packages. All packages can be installed here: ['0-install-pkg.R'](https://github.com/petervitale910/eds214-hurricane/tree/main/0-install-pkg.R)

```{r}
#| message: FALSE
pacman::p_load("tidyverse", "janitor", "here", "ggthemes", "patchwork", "ARTofR")
```

#### Data

First I read in the csv's as well as clean the names and filter for the columns (nutrients) figure 3 focused on. As well as the years we are interested in. This was done in ['reports/data_import.qmd'](https://github.com/petervitale910/eds214-hurricane/tree/main/reports). 
Now I call the variables.

```{r}
q1_data <- read_rds(here::here("outputs","q1_dat.rds"))

q2_data <- read_rds(here::here("outputs","q2_dat.rds"))

q3_data <- read_rds(here::here("outputs","q2_dat.rds"))

mpr_data <- read_rds(here::here("outputs","mpr_dat.rds"))
```



#### Methods

In the paper they calculated the rolling average, an average taken over a set of data points to smooth out the lines. To apply my own rolling average i am using two functions:

1.  {moving_average} : calculates the moving average for one nutrient in the data frame
2.  {df_moving_average} : calculates the moving average for multiple nutrients in a data frame

We need to source these from my *R* folder found here
['R'](https://github.com/petervitale910/eds214-hurricane/blob/main/R)

```{r}
source(here::here("R","moving-average.R"))
source(here::here("R","df-moving-average.R"))
```

Both functions are documented so you are able to find out more information about the inputs by going into the R folder and looking at the file moving-average.R

So now we apply that function to my four data frames.

```{r}
mpr_data <- df_moving_average(df = mpr_data, 
                            dates = sample_date,
                            chem_vec = c("k", "nh4_n", "no3_n", "mg", "ca"))

q1_data <- df_moving_average(df = q1_data, 
                           dates = sample_date,
                           chem_vec = c("k", "nh4_n", "no3_n", "mg", "ca"))

q2_data <- df_moving_average(df = q2_data, 
                           dates = sample_date,
                           chem_vec = c("k", "nh4_n", "no3_n", "mg", "ca"))

q3_data <- df_moving_average(df = q3_data, 
                           dates = sample_date,
                           chem_vec = c("k", "nh4_n", "no3_n", "mg", "ca"))
```

Now all the rolling averages have been calculated and placed in their own columns in our datasets, but we only want one dataframe to graph. So lets merge them using {rbind}

```{r}
all_river_data <- rbind(mpr_data, q1_data, q2_data, q3_data)
```

Ok now lets make some ggplots for each. We need to stack each nutrient so I'm going to be making 5 individual graphs for each of the nutrients

```{r}
#| code-fold: true
#| message: false
k_plot <- ggplot(all_river_data, aes(x = sample_date))+
              geom_line(aes(y = k_rolling_average, 
                            color = sample_id))+
  theme_few()+
  geom_vline(xintercept = as.Date("1989-09-10"),
             linetype = "dotdash") +
  scale_x_date(position = "top")+
  
  labs(y = "K (mg/l)")+
  theme(axis.title.x = element_blank(),
        legend.position = "none",
        axis.title.y = element_text(size = 9))


no3_plot <- ggplot(all_river_data, aes(x = sample_date ))+
  geom_line(aes(y = no3_n_rolling_average, 
                color = sample_id))+
  theme_few()+
  geom_vline(xintercept = as.Date("1989-09-10"),
             linetype = "dotdash") +
  labs(y = "NO3-N (ug/l)",
       color = "River")+
  scale_x_date()+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 9))


nh4_plot <- ggplot(all_river_data, aes(x = sample_date))+
  geom_vline(xintercept = as.Date("1989-09-10"),
             linetype = "dotdash") +
  geom_line(aes(y = nh4_n_rolling_average, 
                color = sample_id))+
  labs(y = "NH4-N (ug/l)",
       x = "Sample Date")+
  theme_few()+
  scale_x_date()+
  theme(legend.position = "none",
        axis.title.y = element_text(size = 9))


mg_plot <- ggplot(all_river_data, aes(x = sample_date))+
  geom_line(aes(y = mg_rolling_average, 
                color = sample_id))+
  labs (y = "Mg (mg/l)")+
  theme_few()+
  scale_x_date()+
  geom_vline(xintercept = as.Date("1989-09-10"),
             linetype = "dotdash") +
  theme(axis.text.x = element_blank(), 
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 9))
  

ca_plot <- ggplot(all_river_data, aes(x = sample_date))+
  geom_line(aes(y = ca_rolling_average,
                color = sample_id))+
  labs(y = "Ca (mg/l)")+
  theme_few()+
  geom_vline(xintercept = as.Date("1989-09-10"),
             linetype = "dotdash") +
  scale_x_date()+
  theme(axis.text.x = element_blank(), 
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 9))

total_plot <- (k_plot/no3_plot/mg_plot/ca_plot/nh4_plot)
```

Let's check in the Results section for the final graph

#### Results

Here I am using functionality from the {patchwork} package to stack all the nutrient graphs

```{r}
#| warning: FALSE
total_plot+plot_annotation(
  subtitle = "Response to Hurricane disturbance in Loquillo Mountain chemestry after Hurricane Hugo (1989)",
  caption = "Dotted line represents when the Hurricane reached Puerto Rico"
  
)
```
